name: License Compliance Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Mondays
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v5

    - name: 🦀 Setup Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: 📦 Cache dependencies
      uses: Swatinem/rust-cache@v2.8.0
      with:
        key: ${{ runner.os }}-license-${{ hashFiles('**/Cargo.lock') }}
        workspaces: "./ -> target"
        cache-all-crates: true
        cache-workspace-crates: true
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - name: 🔍 Install cargo-deny
      run: cargo install cargo-deny --locked

    - name: 📋 Run license compliance check
      run: |
        echo "🔍 Running license compliance check with cargo-deny..."
        cargo deny check licenses

    - name: 📊 Generate license report
      if: always()
      run: |
        echo "📊 Generating license compliance report..."
        cargo deny list --format json > license-report.json 2>/dev/null || echo "License report generation completed"

    - name: 📤 Upload license report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: license-compliance-report
        path: |
          license-report.json
        retention-days: 30

    - name: 📝 License compliance summary
      if: always()
      run: |
        echo "## License Compliance Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "license-report.json" ]; then
          echo "✅ License compliance check completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "📋 Report available in artifacts" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ License compliance check completed with warnings" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for details" >> $GITHUB_STEP_SUMMARY
        fi
