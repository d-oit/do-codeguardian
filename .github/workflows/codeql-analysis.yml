---
name: 🔒 CodeQL Security Analysis

on:
   push:
     branches: [main]
     paths:
       - 'src/**'
       - 'Cargo.toml'
       - 'Cargo.lock'
   pull_request:
     branches: [main, develop]
     paths:
       - 'src/**'
       - 'Cargo.toml'
       - 'Cargo.lock'
   schedule:
     - cron: '0 0 * * 1'  # Weekly on Mondays
   workflow_dispatch:

jobs:
   analyze:
     name: 🔍 CodeQL Analysis
     runs-on: ubuntu-latest
     timeout-minutes: 30
     permissions:
       actions: read
       contents: read
       security-events: write
     strategy:
       fail-fast: false
       matrix:
         language: ['rust']

     steps:
       - name: Checkout repository
         uses: actions/checkout@v5
         with:
           fetch-depth: 0

       - name: Setup Rust toolchain
         uses: actions-rust-lang/setup-rust-toolchain@v1
         with:
           toolchain: stable
           components: rust-src

       - name: Install sccache
         uses: mozilla/sccache-action@v0.0.6

       - name: Generate cache keys
         id: cache-keys
         run: |
           echo "cargo-lock-hash=$(sha256sum Cargo.lock | cut -d' ' -f1)" >> $GITHUB_OUTPUT

       - name: Rust Cache
         uses: Swatinem/rust-cache@v2.8.0
         with:
           key: ${{ runner.os }}-cargo-${{ steps.cache-keys.outputs.cargo-lock-hash }}-stable-codeql
           workspaces: "./ -> target"
           cache-all-crates: true
           cache-workspace-crates: true
           save-if: ${{ github.ref == 'refs/heads/main' }}

       - name: Initialize CodeQL
         uses: github/codeql-action/init@v3.30.3
         with:
           languages: ${{ matrix.language }}
           config-file: ./.github/codeql-config.yml
           # Enable dependency scanning for better vulnerability detection
           queries: security-and-quality

       - name: Build for CodeQL
         run: |
           echo "🔨 Building project for CodeQL analysis..."
           cargo build --release --features full

       - name: Perform CodeQL Analysis
         uses: github/codeql-action/analyze@v3.30.3
         with:
           category: "/language:${{matrix.language}}"
           wait-for-processing: true
           output: sarif-results

       - name: Upload SARIF results
         if: always()
         uses: github/codeql-action/upload-sarif@v3.30.3
         with:
           sarif_file: sarif-results/rust.sarif
           category: "/language:${{matrix.language}}"

       - name: Security Analysis Summary
         if: always()
         run: |
           echo "## 🔒 CodeQL Security Analysis" >> $GITHUB_STEP_SUMMARY
           echo "**Language**: ${{ matrix.language }}" >> $GITHUB_STEP_SUMMARY
           echo "**Status**: Analysis completed" >> $GITHUB_STEP_SUMMARY
           echo "" >> $GITHUB_STEP_SUMMARY
           echo "Security results have been uploaded to GitHub Security tab." >> $GITHUB_STEP_SUMMARY
           echo "Check the Security > Code scanning alerts for detailed findings." >> $GITHUB_STEP_SUMMARY
