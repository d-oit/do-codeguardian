name: CodeGuardian CI (Optimized)

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Fast check job for quick feedback
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: clippy, rustfmt

    - name: Generate cache keys
      id: cache-keys
      run: |
        echo "cargo-lock-hash=$(sha256sum Cargo.lock | cut -d' ' -f1)" >> $GITHUB_OUTPUT
        echo "rust-toolchain=stable" >> $GITHUB_OUTPUT
        echo "os=ubuntu-latest" >> $GITHUB_OUTPUT

    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.8.0
      with:
        key: ${{ runner.os }}-cargo-${{ steps.cache-keys.outputs.cargo-lock-hash }}-${{ steps.cache-keys.outputs.rust-toolchain }}-check
        workspaces: "./ -> target"
        cache-all-crates: true
        cache-workspace-crates: true
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - name: Clippy
      run: |
        echo "ðŸ” Running clippy..."
        if cargo clippy --profile dev-fast --features dev -- -D warnings; then
          echo "âœ… Clippy check passed"
        else
          echo "âŒ Clippy check failed"
          exit 1
        fi

    - name: Format Check
      run: |
        echo "ðŸ” Running format check..."
        if cargo fmt --check; then
          echo "âœ… Format check passed"
        else
          echo "âŒ Format check failed - run 'cargo fmt' to fix"
          exit 1
        fi

  # Test job with parallel execution
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: check

    steps:
    - uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Generate cache keys
      id: cache-keys
      run: |
        echo "cargo-lock-hash=$(sha256sum Cargo.lock | cut -d' ' -f1)" >> $GITHUB_OUTPUT
        echo "rust-toolchain=stable" >> $GITHUB_OUTPUT
        echo "os=ubuntu-latest" >> $GITHUB_OUTPUT

    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.8.0
      with:
        key: ${{ runner.os }}-cargo-${{ steps.cache-keys.outputs.cargo-lock-hash }}-${{ steps.cache-keys.outputs.rust-toolchain }}-test
        workspaces: "./ -> target"
        cache-all-crates: true
        cache-workspace-crates: true
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - name: Run Tests
      id: run_tests
      run: |
        echo "ðŸ§ª Running test suite..."
        if cargo test --profile dev-fast --features dev -- --format=json | tee test-results.json; then
          echo "âœ… All tests passed"
          echo "test_status=passed" >> $GITHUB_OUTPUT
        else
          echo "âŒ Some tests failed"
          echo "test_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Run Benchmarks
      id: run_benchmarks
      run: |
        echo "âš¡ Running benchmarks (non-critical)..."
        if cargo bench --profile bench --features full; then
          echo "âœ… Benchmarks completed successfully"
          echo "benchmark_status=passed" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸  Benchmarks failed, but continuing (non-critical)"
          echo "benchmark_status=failed" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    - name: Generate Test Summary
      if: always()
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.run_tests.outcome }}" == "success" ]; then
          echo "âœ… **Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.run_benchmarks.outcome }}" == "success" ]; then
          echo "âœ… **Benchmarks**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸  **Benchmarks**: Failed (non-critical)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.run_id }}
        path: |
          test-results.json
        retention-days: 30

  # License compliance job
  license:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: check

    steps:
    - uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Generate cache keys
      id: cache-keys
      run: |
        echo "cargo-lock-hash=$(sha256sum Cargo.lock | cut -d' ' -f1)" >> $GITHUB_OUTPUT
        echo "rust-toolchain=stable" >> $GITHUB_OUTPUT
        echo "os=ubuntu-latest" >> $GITHUB_OUTPUT

    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.8.0
      with:
        key: ${{ runner.os }}-cargo-${{ steps.cache-keys.outputs.cargo-lock-hash }}-${{ steps.cache-keys.outputs.rust-toolchain }}-license
        workspaces: "./ -> target"
        cache-all-crates: true
        cache-workspace-crates: true
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - name: License Compliance Check
      id: license_check
      run: |
        echo "ðŸ“‹ Running license compliance check..."
        cargo install cargo-deny --locked

        if ../scripts/license-check-fallback.sh; then
          echo "âœ… License compliance check passed"
          echo "license_status=passed" >> $GITHUB_OUTPUT
        else
          echo "âŒ License compliance violations found"
          echo "license_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Generate License Report
      if: always()
      run: |
        echo "## License Compliance Report" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.license_check.outcome }}" == "success" ]; then
          echo "âœ… **License Check**: All dependencies compliant" >> $GITHUB_STEP_SUMMARY

          # Generate summary of licenses used
          echo "### License Summary" >> $GITHUB_STEP_SUMMARY
          cargo deny list | head -20 >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **License Check**: Violations detected" >> $GITHUB_STEP_SUMMARY
          echo "Check license-results.json for details" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload License Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: license-results-${{ github.run_id }}
        path: |
          license-results.json
        retention-days: 30

  # Security audit job
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: check

    steps:
    - uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Generate cache keys
      id: cache-keys
      run: |
        echo "cargo-lock-hash=$(sha256sum Cargo.lock | cut -d' ' -f1)" >> $GITHUB_OUTPUT
        echo "rust-toolchain=stable" >> $GITHUB_OUTPUT
        echo "os=ubuntu-latest" >> $GITHUB_OUTPUT

    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.8.0
      with:
        key: ${{ runner.os }}-cargo-${{ steps.cache-keys.outputs.cargo-lock-hash }}-${{ steps.cache-keys.outputs.rust-toolchain }}-audit
        workspaces: "./ -> target"
        cache-all-crates: true
        cache-workspace-crates: true
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - name: Security Audit
      id: security_audit
      run: |
        echo "ðŸ”’ Running security audit..."
        cargo install cargo-audit --locked

        if cargo audit --format json > audit-results.json; then
          echo "âœ… Security audit passed - no vulnerabilities found"
          echo "audit_status=passed" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸  Security audit found issues (review audit-results.json)"
          echo "audit_status=issues_found" >> $GITHUB_OUTPUT
          # Don't fail the job for security audit issues - log them instead
        fi
      continue-on-error: true

    - name: Audit Summary
      if: always()
      run: |
        echo "## Security Audit Summary" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.security_audit.outcome }}" == "success" ]; then
          echo "âœ… **Security Audit**: No issues found" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸  **Security Audit**: Issues detected (check artifacts)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Audit Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: audit-results-${{ github.run_id }}
        path: |
          audit-results.json
        retention-days: 30

  # Build and release job
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test, audit, license]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Generate cache keys
      id: cache-keys
      run: |
        echo "cargo-lock-hash=$(sha256sum Cargo.lock | cut -d' ' -f1)" >> $GITHUB_OUTPUT
        echo "rust-toolchain=stable" >> $GITHUB_OUTPUT
        echo "os=ubuntu-latest" >> $GITHUB_OUTPUT

    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.8.0
      with:
        key: ${{ runner.os }}-cargo-${{ steps.cache-keys.outputs.cargo-lock-hash }}-${{ steps.cache-keys.outputs.rust-toolchain }}-build
        workspaces: "./ -> target"
        cache-all-crates: true
        cache-workspace-crates: true
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - name: Build Release
      run: |
        echo "ðŸ”¨ Building release binary..."
        if cargo build --release --features full; then
          echo "âœ… Release build successful"
        else
          echo "âŒ Release build failed"
          exit 1
        fi

    - name: Run Integration Tests
      id: integration_tests
      run: |
        echo "ðŸ§ª Running integration tests..."
        if cargo test --release --features full --test integration_tests -- --format=json | tee integration-test-results.json; then
          echo "âœ… Integration tests passed"
          echo "integration_status=passed" >> $GITHUB_OUTPUT
        else
          echo "âŒ Integration tests failed"
          echo "integration_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Upload Binary
      uses: actions/upload-artifact@v4
      with:
        name: codeguardian-binary
        path: target/release/do-codeguardian

    - name: Upload Integration Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results-${{ github.run_id }}
        path: |
          integration-test-results.json
        retention-days: 30

  # License compliance job
  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'schedule'

    steps:
    - uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Generate cache keys
      id: cache-keys
      run: |
        echo "cargo-lock-hash=$(sha256sum Cargo.lock | cut -d' ' -f1)" >> $GITHUB_OUTPUT
        echo "rust-toolchain=stable" >> $GITHUB_OUTPUT
        echo "os=ubuntu-latest" >> $GITHUB_OUTPUT

    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.8.0
      with:
        key: ${{ runner.os }}-cargo-${{ steps.cache-keys.outputs.cargo-lock-hash }}-${{ steps.cache-keys.outputs.rust-toolchain }}-performance
        workspaces: "./ -> target"
        cache-all-crates: true
        cache-workspace-crates: true
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - name: Run Performance Benchmarks
      id: performance_benchmarks
      run: |
        echo "ðŸ“Š Running performance analysis..."
        if ./scripts/performance_analysis.sh; then
          echo "âœ… Performance analysis completed successfully"
          echo "performance_status=passed" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸  Performance analysis failed, but continuing (non-critical)"
          echo "performance_status=failed" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    - name: Performance Summary
      if: always()
      run: |
        echo "## Performance Analysis Summary" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.performance_benchmarks.outcome }}" == "success" ]; then
          echo "âœ… **Performance Analysis**: Completed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸  **Performance Analysis**: Failed (non-critical)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Performance Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-results-${{ github.run_id }}
        path: |
          target/criterion/**/*
          *.log
        retention-days: 7
